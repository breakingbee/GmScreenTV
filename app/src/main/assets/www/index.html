<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>GmScreen TV</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
  :root{ --bg:#0f0f10; --card:#1b1c1f; --accent:#2b63ff; --focus:#ffcc00; --txt:#fff; --muted:#b9bcc4; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--txt);font-family:Arial,Helvetica,sans-serif;overflow:hidden}
  h2{margin:16px 0 10px;text-align:center}
  .row{display:flex;justify-content:center;flex-wrap:wrap;gap:10px}
  .btn{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:12px 16px;font-size:16px;font-weight:bold;min-width:150px}
  .btn:focus{outline:3px solid var(--focus)}
  .status{text-align:center;color:var(--muted);margin:8px 0}
  .toolbar{display:flex;justify-content:center;align-items:center;gap:10px;margin:8px 0}
  .search,.sat{height:44px;border-radius:8px;border:1px solid #30333a;background:#141519;color:#fff;padding:0 14px;font-size:16px}
  .sat{min-width:220px}
  .search:focus,.sat:focus{outline:3px solid var(--focus)}
  #listWrap{height:58vh;max-width:1100px;margin:0 auto;padding:0 10px 10px;overflow-y:auto}
  .item{display:flex;gap:10px;align-items:center;background:var(--card);border-radius:10px;padding:10px 10px;margin:6px 0}
  .name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .id{color:var(--muted);font-size:14px}
  .action{display:flex;gap:8px}
  .small{min-width:100px}
  .kbd{font-family:monospace;color:var(--muted)}
  .count{text-align:center;color:var(--muted);margin:4px 0 8px}
  #debug{display:none;white-space:pre-wrap;background:#0b0c0f;border-top:1px solid #262830;padding:10px;height:20vh;overflow:auto}
</style>
</head>
<body>
  <h2>GmScreen TV</h2>

  <div class="row">
    <button id="btnAuto"  class="btn" tabindex="0">Auto-detect STB</button>
    <button id="btnIp"    class="btn" tabindex="0">Change IP</button>
    <button id="btnFetch" class="btn" tabindex="0">Fetch channels</button>
    <button id="btnDebug" class="btn" tabindex="0">Show debug</button>
  </div>

  <div class="status">Connected to: <span id="ip">–</span></div>

  <div class="toolbar">
    <input id="search" class="search" placeholder="Search name or ServiceID…" tabindex="0">
    <select id="sat" class="sat" tabindex="0"><option value="">All satellites</option></select>
  </div>
  <div class="count" id="count">Channels: 0</div>

  <div id="listWrap" tabindex="-1"></div>

  <div id="debug"></div>

<script>
(function(){
  const ipSpan   = document.getElementById('ip');
  const listWrap = document.getElementById('listWrap');
  const count    = document.getElementById('count');
  const searchEl = document.getElementById('search');
  const satSel   = document.getElementById('sat');
  const debugBox = document.getElementById('debug');

  function getIp(){ try{ return NativeBridge.getStbIp(); }catch(e){ return ""; } }
  function setIp(ip){ try{ NativeBridge.setStbIp(ip); }catch(e){} ipSpan.textContent = ip || "–"; }
  setIp(getIp());

  let all = [];      // all channels
  let shown = [];    // filtered
  let satellites = [];// {index,name}

  function row(ch){
    const div = document.createElement('div');
    div.className='item';
    const left = document.createElement('div');
    left.className='name';
    left.textContent = ch.name || 'Channel';

    const id = document.createElement('div');
    id.className='id';
    const satLabel = ch.satName ? ` · ${ch.satName}` : (ch.satIndex!=null ? ` · sat#${ch.satIndex}` : '');
    id.textContent = (ch.id?`[${ch.id}]`:'') + satLabel;

    const act = document.createElement('div'); act.className='action';
    const bPlay = document.createElement('button'); bPlay.className='btn small'; bPlay.textContent='Play';
    bPlay.onclick = ()=>{ try{ NativeBridge.openInVlc(ch.url); }catch(e){} };

    const bSwitch = document.createElement('button'); bSwitch.className='btn small'; bSwitch.textContent='Switch';
    bSwitch.title = 'Tell STB to tune this channel';
    bSwitch.onclick = ()=>{
      try{ NativeBridge.switchToServiceId(String(ch.id||'')); }catch(e){}
    };

    act.appendChild(bPlay);
    act.appendChild(bSwitch);

    div.appendChild(left); div.appendChild(id); div.appendChild(act);
    return div;
  }

  function render(list){
    listWrap.innerHTML = '';
    list.forEach(ch => listWrap.appendChild(row(ch)));
    count.textContent = 'Channels: ' + list.length;
  }

  function applyFilter(){
    const q = (searchEl.value||'').toLowerCase().trim();
    const s = satSel.value || '';
    shown = all.filter(ch => {
      const bySat = !s || (String(ch.satIndex||'') === s);
      if (!bySat) return false;
      if (!q) return true;
      const name = (ch.name||'').toLowerCase();
      const id   = String(ch.id||'').toLowerCase();
      return name.includes(q) || id.includes(q);
    });
    render(shown);
  }
  searchEl.addEventListener('input', applyFilter);
  satSel.addEventListener('change', applyFilter);

  document.getElementById('btnAuto').onclick = function(){
    try{
      const json = NativeBridge.discoverUdp25860(3000);
      const arr = JSON.parse(json||'[]');
      if (arr.length){ setIp(arr[0].ip); alert('Found STB: '+arr[0].ip); }
      else alert('No STB beacons seen.');
    }catch(e){ alert('Auto-detect failed'); }
  };
  document.getElementById('btnIp').onclick = function(){
    const cur = getIp();
    const ip = prompt('Enter STB IP', cur||'');
    if (ip){ setIp(ip); alert('Saved: '+ip); }
  };

  // Fetch, parse satellites/meta, then filter by satellite automatically
  document.getElementById('btnFetch').onclick = function(){
    try{
      const json = NativeBridge.fetchChannelsFromStb();
      const arr = JSON.parse(json||'[]');

      // peel meta marker (last object containing __meta)
      satellites = [];
      if (arr.length && arr[arr.length-1] && arr[arr.length-1].__meta) {
        const meta = arr.pop().__meta;
        satellites = (meta.satellites||[]);
      }

      all = arr;

      // fill satellite dropdown
      satSel.innerHTML = '<option value="">All satellites</option>';
      satellites.forEach(s => {
        const opt = document.createElement('option');
        opt.value = String(s.index);
        opt.textContent = s.name + ' (idx ' + s.index + ')';
        satSel.appendChild(opt);
      });

      // if many channels have a satIndex, pick the most common as default
      const counts = {};
      all.forEach(ch => { const k = String(ch.satIndex||''); if (k) counts[k]=(counts[k]||0)+1; });
      let bestKey=''; let bestCount=0;
      for (const k in counts){ if (counts[k]>bestCount){ bestKey=k; bestCount=counts[k]; } }
      if (bestKey){ satSel.value = bestKey; }

      applyFilter();
      if (!all.length) alert('No channels parsed. Open Debug to inspect.');
    }catch(e){
      alert('Fetch failed');
    }
  };

  document.getElementById('btnDebug').onclick = function(){
    debugBox.style.display='block';
    debugBox.textContent = (function(){ try{return NativeBridge.getLastDebug();}catch(e){return '';} })();
  };

  // start focus on search for TV keyboards
  setTimeout(()=>{ searchEl.focus(); }, 80);
})();
</script>
</body>
</html>
