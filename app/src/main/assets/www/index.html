<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>GM Screen – Offline Satellite List</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
  :root { --bg:#121417; --card:#1b1f24; --muted:#8fa0b3; --accent:#3fa9ff; --txt:#e6edf3; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{padding:14px 16px;border-bottom:1px solid #26303a;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
  header h1{font-size:18px;margin:0}
  header .ip{margin-left:auto;font-size:12px;color:var(--muted)}
  main{display:grid;grid-template-columns:280px 1fr;gap:12px;padding:12px}
  @media (max-width:900px){ main{grid-template-columns:1fr} }
  .panel{background:var(--card);border:1px solid #26303a;border-radius:10px;overflow:hidden}
  .panel h2{margin:0;padding:12px 14px;border-bottom:1px solid #26303a;font-size:14px;color:#bcd0e0}
  .panel .body{padding:10px 12px}
  .list{display:flex;flex-direction:column;gap:8px;max-height:70vh;overflow:auto}
  .sat,.chan{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px;border:1px solid #2a3642;background:#171b20;border-radius:8px}
  .sat:hover,.chan:hover{border-color:#334454}
  .title{font-weight:600}
  .sub{font-size:12px;color:var(--muted)}
  .btn{appearance:none;border:1px solid #2e3b47;background:#0f6fca;color:#fff;padding:8px 12px;border-radius:8px;font-weight:600;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .ghost{background:#0e151b;border-color:#2a3642;color:#c7d6e6}
  .danger{background:#c92c2c;border-color:#c92c2c}
  .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:10px}
  input[type="search"]{width:100%;padding:10px 12px;border-radius:8px;border:1px solid #2a3642;background:#0f141a;color:var(--txt)}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;font-size:12px;color:#aabbd0}
  .hint{color:var(--muted);font-size:12px;margin-top:6px}
</style>
</head>
<body>
<header>
  <h1>GM Screen</h1>
  <button class="btn ghost" id="btnChangeIp" title="Used when building stream URLs">Change IP</button>
  <div class="ip" id="ipBox">IP: —</div>
</header>

<main>
  <!-- Left: Satellites -->
  <section class="panel" id="satPanel">
    <h2>Satellites (offline)</h2>
    <div class="body">
      <div class="list" id="satList"></div>
      <div class="hint">This list comes from <span class="mono">/assets/www/data/satellites.json</span>.</div>
    </div>
  </section>

  <!-- Right: Channels -->
  <section class="panel">
    <h2 id="chanHeader">Channels</h2>
    <div class="body">
      <div class="toolbar">
        <input id="searchBox" type="search" placeholder="Search channel name or ServiceID…"/>
        <button class="btn ghost" id="btnClear">Clear</button>
      </div>
      <div class="list" id="chanList"></div>
      <div id="chanInfo" class="hint"></div>
    </div>
  </section>
</main>

<script>
(() => {
  // ---------- Helpers ----------
  const q = s => document.querySelector(s);
  const el = (tag, cls) => { const e=document.createElement(tag); if(cls) e.className=cls; return e; };

  function getIp(){
    try { return (window.NativeBridge && NativeBridge.getStbIp()) || ""; }
    catch(_) { return ""; }
  }
  function setIp(ip){
    try { if(window.NativeBridge) NativeBridge.setStbIp(ip); } catch(_){}
    renderIp();
  }
  function renderIp(){
    const ip = getIp();
    q('#ipBox').textContent = 'IP: ' + (ip || '— not set');
  }

  // Play helper: prefer explicit URL in JSON; else build from IP + ServiceID.
  function playChannel(item){
    const ip = getIp();
    const url = item.url || (ip ? `http://${ip}:8085/player.${item.ServiceID}` : "");
    if(!url){
      alert("No URL and no IP set.\nSet your STB IP to build URLs like http://<ip>:8085/player.<ServiceID>.");
      return;
    }
    try {
      if (window.NativeBridge) NativeBridge.openInVlc(url);
      else window.open(url, "_blank");
    } catch(e){}
  }

  // ---------- Loaders ----------
  const DATA_ROOT = "data";
  async function loadJson(relPath){
    const url = `${DATA_ROOT}/${relPath}`; // served from file:///android_asset/www/
    const res = await fetch(url);
    if(!res.ok) throw new Error(`Failed to load ${relPath}: ${res.status}`);
    return await res.json();
  }

  // satellites.json -> render list
  async function loadSatellites(){
    const satList = q('#satList'); satList.innerHTML = '';
    try{
      const sats = await loadJson('satellites.json');
      sats.forEach(s => {
        const row = el('div','sat');
        const left = el('div');
        const t = el('div','title'); t.textContent = s.name || s.id;
        const d = el('div','sub'); d.textContent = s.description || s.file;
        left.appendChild(t); left.appendChild(d);
        const btn = el('button','btn'); btn.textContent = 'Open';
        btn.onclick = () => loadChannelsForSatellite(s);
        row.append(left, btn);
        satList.appendChild(row);
      });
      if (sats.length) loadChannelsForSatellite(sats[0]); // auto-open first
    }catch(err){
      satList.innerHTML = `<div class="hint">Could not load satellites.json<br><span class="mono">${err}</span></div>`;
    }
  }

  // astra_19e.json (etc) -> render channels
  let currentChannels = [];
  async function loadChannelsForSatellite(sat){
    q('#chanHeader').textContent = `Channels – ${sat.name || sat.id}`;
    q('#chanList').innerHTML = 'Loading…';
    q('#chanInfo').textContent = '';
    try{
      const arr = await loadJson(sat.file);
      currentChannels = Array.isArray(arr) ? arr : [];
      renderChannels(currentChannels);
      q('#chanInfo').textContent = `${currentChannels.length} channels`;
    }catch(err){
      q('#chanList').innerHTML = `<div class="hint">Failed to load <span class="mono">${sat.file}</span><br><span class="mono">${err}</span></div>`;
    }
  }

  // render + search
  function renderChannels(list){
    const box = q('#chanList'); box.innerHTML = '';
    list.forEach(item => {
      const row = el('div','chan');
      const left = el('div');
      const t = el('div','title'); t.textContent = item.ServiceName || 'Channel';
      const s = el('div','sub');  s.textContent = `${item.ServiceID || ''}${item.HD ? ' · HD':''}`;
      left.append(t, s);
      const btn = el('button','btn'); btn.textContent = 'Play';
      btn.onclick = () => playChannel(item);
      row.append(left, btn);
      box.appendChild(row);
    });
  }

  q('#searchBox').addEventListener('input', e => {
    const term = e.target.value.trim().toLowerCase();
    if (!term) { renderChannels(currentChannels); return; }
    const filtered = currentChannels.filter(ch =>
      (ch.ServiceName||'').toLowerCase().includes(term) ||
      (ch.ServiceID||'').toLowerCase().includes(term)
    );
    renderChannels(filtered);
    q('#chanInfo').textContent = `${filtered.length} / ${currentChannels.length} shown`;
  });
  q('#btnClear').onclick = () => { q('#searchBox').value=''; renderChannels(currentChannels); q('#chanInfo').textContent = `${currentChannels.length} channels`; };

  // IP controls
  q('#btnChangeIp').onclick = () => {
    const cur = getIp() || "";
    const val = prompt("Enter your STB IP (used to build http://IP:8085/player.<ServiceID>)", cur);
    if (val) setIp(val.trim());
  };

  // boot
  renderIp();
  loadSatellites();
})();
</script>
</body>
</html>
