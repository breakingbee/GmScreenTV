<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>GmScreen TV</title>
<style>
  body{background:#2e2f33;color:#e9eef3;margin:0;font-family:Arial,Helvetica,sans-serif}
  h2{margin:18px 0 8px}
  .wrap{display:flex;height:100vh}
  .left{width:420px;min-width:420px;border-right:2px solid #444;padding:16px;box-sizing:border-box;overflow:auto}
  .right{flex:1;padding:16px;box-sizing:border-box;overflow:auto}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0}
  .btn{background:#3b82f6;border:none;border-radius:10px;color:#fff;font-weight:700;font-size:16px;padding:10px 16px}
  .btn:focus{outline:2px solid #ffcc00}
  .btn.gray{background:#6b7280}
  .btn.red{background:#ef4444}
  .btn.green{background:#22c55e}
  .btn.tiny{font-size:14px;padding:8px 12px}
  .pill{background:#46546b;color:#cde0ff;border-radius:12px;padding:2px 8px;font-size:12px;margin-left:8px}
  input.txt{flex:1;min-width:120px;background:#1d1f24;border:1px solid #4b5563;border-radius:10px;color:#e9eef3;padding:12px 14px}
  .item{background:#1f2630;border:1px solid #3a4656;border-radius:12px;padding:10px 12px;margin:8px 0}
  .name{font-size:16px;font-weight:600}
  .meta{opacity:.8;font-size:12px;margin-left:8px}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .mono{font-family:monospace;font-size:12px;white-space:pre-wrap;background:#111827;border:1px solid #334155;border-radius:10px;padding:8px;max-height:26vh;overflow:auto}
  .section{margin-top:8px;margin-bottom:12px}
  .section h3{margin:0 0 8px}
</style>
</head>
<body>
<div class="wrap">
  <div class="left">
    <h2>Connection</h2>
    <div class="row">
      <button class="btn" id="btnUdp">Auto-detect STB</button>
      <button class="btn gray" id="btnChangeIp">Change IP</button>
    </div>
    <div id="curip" style="opacity:.9;margin-bottom:12px"></div>

    <div class="section">
      <h3>Fetch</h3>
      <div class="row">
        <button class="btn" id="btnFetch">Fetch channels (long listen)</button>
        <button class="btn red" id="btnClear">Clear list</button>
      </div>
      <div style="opacity:.8">Socket open ~12s. We tune before playing so VLC doesnâ€™t show black.</div>
    </div>

    <div class="section">
      <h3>Play by ID</h3>
      <div class="row">
        <input id="chanId" class="txt" placeholder="Channel ID (e.g., 22621080)">
      </div>
      <div class="row">
        <button class="btn green" id="btnPlayById">Play in VLC</button>
      </div>
    </div>

    <div class="section">
      <h3>Debug</h3>
      <div class="row"><button class="btn tiny gray" id="btnShowDebug">Show debug</button></div>
      <div id="debug" class="mono"></div>
    </div>
  </div>

  <div class="right">
    <div class="row">
      <input class="txt" id="search" placeholder="Search channel name or ServiceID...">
    </div>
    <div id="count" style="margin:6px 0;opacity:.9"></div>
    <div id="list"></div>
  </div>
</div>

<script>
(function(){
  const byId = x => document.getElementById(x);
  const state = { all: [], view: [], ip: "" };

  function renderIp(){
    try{ state.ip = NativeBridge.getStbIp(); }catch(e){ state.ip=""; }
    byId('curip').textContent = state.ip ? ("Connected to: "+state.ip) : "No STB IP set";
  }
  renderIp();

  // --- autodetect ---
  byId('btnUdp').onclick = function(){
    try{
      const json = NativeBridge.discoverUdp25860(3000);
      const arr = JSON.parse(json||"[]");
      if (!arr.length) { alert("No UDP beacons found."); return; }
      const pick = arr[0];
      NativeBridge.setStbIp(pick.ip);
      alert("Using: "+pick.ip);
      renderIp();
    }catch(e){ alert("Detect failed."); }
  };

  byId('btnChangeIp').onclick = function(){
    const cur = state.ip||"";
    const ip = prompt("Enter STB IP", cur);
    if (ip) { try { NativeBridge.setStbIp(ip); }catch(e){}; renderIp(); }
  };

  // --- list rendering ---
  function mkItem(it) {
    const div = document.createElement('div'); div.className='item'; div.tabIndex=0;
    const title = document.createElement('div');
    title.innerHTML = `<span class="name">${(it.name||'Channel')}</span>
                       <span class="meta">[${it.id||'no-sid'}]</span>
                       <span class="pill">idx ${it.index}</span>`;
    const actions = document.createElement('div'); actions.className='actions';

    const tune = document.createElement('button'); tune.className='btn tiny green'; tune.textContent='Tune + VLC';
    tune.onclick = () => { try{ NativeBridge.tuneAndPlay(it.index); }catch(e){} };

    const vlc = document.createElement('button'); vlc.className='btn tiny'; vlc.textContent='Play URL only';
    vlc.onclick = () => { try{ NativeBridge.openInVlc(it.url); }catch(e){} };

    actions.appendChild(tune);
    actions.appendChild(vlc);
    div.appendChild(title);
    div.appendChild(actions);
    return div;
  }

  function renderList(arr){
    state.view = arr;
    byId('count').textContent = "Channels: "+arr.length;
    const box = byId('list'); box.innerHTML='';
    arr.forEach(it => box.appendChild(mkItem(it)));
  }

  function applySearch() {
    const q = (byId('search').value||"").trim().toLowerCase();
    if (!q) { renderList(state.all); return; }
    const out = state.all.filter(it =>
      (it.name||"").toLowerCase().includes(q) ||
      (String(it.id||"").includes(q)) ||
      (String(it.index||"").includes(q)));
    renderList(out);
  }
  byId('search').oninput = applySearch;

  // --- fetch channels ---
  byId('btnFetch').onclick = function(){
    try{
      const json = NativeBridge.fetchChannelsFromStb();
      const arr = JSON.parse(json||"[]");
      state.all = arr;
      renderList(arr);
      byId('debug').textContent = NativeBridge.getLastDebug();
    }catch(e){
      alert("Fetch failed");
    }
  };

  byId('btnClear').onclick = function(){
    state.all = []; renderList([]);
  };

  // play by id
  byId('btnPlayById').onclick = function(){
    const id = (byId('chanId').value||"").trim();
    if (!id) { alert("Enter ServiceID"); return; }
    try { NativeBridge.openChannelById(id); } catch(e) {}
  };

  // debug
  byId('btnShowDebug').onclick = function(){
    try{ byId('debug').textContent = NativeBridge.getLastDebug(); }catch(e){}
  };
})();
</script>
</body>
</html>
